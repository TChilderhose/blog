<!doctype html><html lang=en data-theme=dark>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self'; form-action 'self'; frame-src 'self' https://utteranc.es; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://utteranc.es; prefetch-src 'self'; connect-src 'self';">
<meta name=author content="Tyler Childerhose">
<meta name=description content="Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, K-9 Mail.">
<meta name=keywords content="blog,developer,personal">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Connecting to ProtonMail Bridge with K-9 Mail on Android">
<meta name=twitter:description content="Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, K-9 Mail.">
<meta property="og:title" content="Connecting to ProtonMail Bridge with K-9 Mail on Android">
<meta property="og:description" content="Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, K-9 Mail.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://tchilderhose.ca/posts/2021/11/protonmail-k9/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-03T00:00:00+00:00">
<meta property="article:modified_time" content="2021-11-03T00:00:00+00:00">
<title>
Connecting to ProtonMail Bridge with K-9 Mail on Android · TChilderhose
</title>
<link rel=canonical href=https://tchilderhose.ca/posts/2021/11/protonmail-k9/>
<link rel=stylesheet href=/css/site.min.9adf3898c5a4b575235d67b06d6fd1491dc82e04bc01e5ab044976a26dc6b31d.css integrity="sha256-mt84mMWktXUjXWewbW/RSR3ILgS8AeWrBEl2om3Gsx0=" crossorigin=anonymous>
<link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png sizes=180x180>
<meta name=generator content="Hugo 0.89.0">
<script>document.addEventListener("DOMContentLoaded",function(){document.querySelector(".preload-transitions").classList.remove("preload-transitions")})</script>
</head>
<body class=preload-transitions>
<aside class=float-container>
<ul>
<li>
<a id=to-top>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M8 256C8 119 119 8 256 8s248 111 248 248-111 248-248 248S8 393 8 256zm292 116V256h70.9c10.7.0 16.1-13 8.5-20.5L264.5 121.2c-4.7-4.7-12.2-4.7-16.9.0l-115 114.3c-7.6 7.6-2.2 20.5 8.5 20.5H212v116c0 6.6 5.4 12 12 12h64c6.6.0 12-5.4 12-12z"/></svg></i>
</a>
</li>
<li>
<a id=dark-mode-toggle>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg></i>
</a>
</li>
</ul>
</aside>
<main class=wrapper>
<nav class=navigation id=navbar>
<section class=container>
<a class=navigation-title href=/>
TChilderhose
</a>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/resume/>Resume</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class=container>
<aside class=toc>
<h2 class=toc-title>Table of Contents</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#my-setup>My Setup</a></li>
<li><a href=#attempt-1---official-protonmail-bridge-deb>Attempt 1 - Official ProtonMail Bridge (deb)</a>
<ul>
<li><a href=#install>Install</a></li>
<li><a href=#k-9-mail>K-9 Mail</a></li>
<li><a href=#issues>Issues</a></li>
</ul>
</li>
<li><a href=#attempt-2---proxy-to-official-protonmail-bridge-deb>Attempt 2 - Proxy to Official ProtonMail Bridge (deb)</a>
<ul>
<li><a href=#socat-proxy>Socat Proxy</a></li>
<li><a href=#issues-1>Issues</a></li>
</ul>
</li>
<li><a href=#attempt-3---compile-protonmail-bridge-myself>Attempt 3 - Compile ProtonMail Bridge Myself</a>
<ul>
<li><a href=#my-repo>My Repo</a></li>
<li><a href=#solution>Solution</a></li>
</ul>
</li>
<li><a href=#summary>Summary</a></li>
</ul>
</nav>
</aside>
<article class=post>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://tchilderhose.ca/posts/2021/11/protonmail-k9/>
Connecting to ProtonMail Bridge with K-9 Mail on Android
</a>
</h1>
</div>
<div class=post-meta>
<span class=posted-on>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 464c0 26.5 21.5 48 48 48h352c26.5.0 48-21.5 48-48V192H0v272zm320-196c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6.0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6.0-12-5.4-12-12v-40zM192 268c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6.0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6.0-12-5.4-12-12v-40zM64 268c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6.0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6.0-12-5.4-12-12v-40zM4e2 64h-48V16c0-8.8-7.2-16-16-16h-32c-8.8.0-16 7.2-16 16v48H160V16c0-8.8-7.2-16-16-16h-32c-8.8.0-16 7.2-16 16v48H48C21.5 64 0 85.5.0 112v48h448v-48c0-26.5-21.5-48-48-48z"/></svg></i>
<time datetime=2021-11-03T00:00:00Z>2021-11-03</time>
</span>
&nbsp;
<span class=reading-time>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C119 8 8 119 8 256S119 504 256 504 504 393 504 256 393 8 256 8zm92.49 313h0l-20 25A16 16 0 01306 348.5h0l-67-49.72a40 40 0 01-15-31.23V112a16 16 0 0116-16h32a16 16 0 0116 16V256l58 42.5A16 16 0 01348.49 321z"/></svg></i>6-minute read</span>
&nbsp;
<span class=tags>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg></i>
<a class=tag-link href=/tags/docker/>docker</a>
<span class=separator>•</span>
<a class=tag-link href=/tags/protonmail/>protonmail</a>
<span class=separator>•</span>
<a class=tag-link href=/tags/k9-mail/>K9 Mail</a>
<span class=separator>•</span>
<a class=tag-link href=/tags/android/>android</a></span>
</div>
</header>
<div>
<p>Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, <a href=https://github.com/k9mail/k-9>K-9 Mail</a>.</p>
<p>The main issue with this is that ProtonMail doesn&rsquo;t have native IMAP support. But, they do have a <a href=https://protonmail.com/bridge/>ProtonMail Bridge</a> which simulates IMAP. They say ThunderBird is offically supported, which is a fairly robust Email client, so I was optimistic that I could get K-9 to work.</p>
<p>TL;DR Note: If you want to skip over my trys and only want to know how to get it working, you can skip to my <a href=#solution>solution</a>.</p>
<section>
<h2 id=my-setup>
My Setup
<a class=heading-link href=#my-setup>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h2>
<p>I run a linux based server that is on my home network. It is headless (no monitor) and runs a handful of docker microservices. Most of them do not matter for this write-up, but one that does play a a fairly large role is my <a href=https://docs.linuxserver.io/images/docker-wireguard>Wireguard VPN</a> container, which my phone is 100% always connected to. This allows my to connect directly to my server from my phone using it&rsquo;s internal IP address and not needing to expose it to the internet.</p>
<p>My phone is Android 11 and has a kernal with wireguard built-in. This allows me to be connected to Wireguard all the time doesn&rsquo;t effect battery that much. K-9 mail was installed through <a href=https://f-droid.org/packages/com.fsck.k9/>f-droid</a>.</p>
<p>I have ProntonMail Plus, which is needed in order to use the ProtonMail Bridge.</p>
</section>
<section>
<h2 id=attempt-1---official-protonmail-bridge-deb>
Attempt 1 - Official ProtonMail Bridge (deb)
<a class=heading-link href=#attempt-1---official-protonmail-bridge-deb>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h2>
<h3 id=install>
Install
<a class=heading-link href=#install>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h3>
<p>First thing I did was download and install the <code>.deb</code> from <a href=https://protonmail.com/bridge/install>ProntonMail&rsquo;s website</a>. My linux server is normally headless, so I decided to pull out an extra monitor I had around, temporarily setup a desktop and set up my account through the gui and was given a popup similar to this:</p>
<p><figure>
<picture>
<source srcset=install_config-placeholder.webp data-srcset=install_config.webp type=image/webp>
<img src=install_config-placeholder.png data-src=install_config.png type=image/png alt="Example picture from ProtonMail&amp;rsquo;s website" loading=lazy width=427 height=584>
</picture>
<figcaption>
<p class=caption>Example picture from ProtonMail&amp;rsquo;s website</p>
</figcaption>
</figure></p>
<p>Looking like the bridge was up and running, I launched K-9 Mail and started adding the account.</p>
<h3 id=k-9-mail>
K-9 Mail
<a class=heading-link href=#k-9-mail>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h3>
<p>I used the all the settings that ProtonMail gave me (username, password port) but for IP address I used the internal address for my server instead of <code>127.0.0.1</code>.
<figure>
<picture>
<source srcset=k9_setup-placeholder.webp data-srcset=k9_setup.webp type=image/webp>
<img src=k9_setup-placeholder.png data-src=k9_setup.png type=image/png alt="K-9 Mail Settings" loading=lazy width=432 height=889>
</picture>
<figcaption>
<p class=caption>K-9 Mail Settings</p>
</figcaption>
</figure></p>
<h3 id=issues>
Issues
<a class=heading-link href=#issues>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h3>
<p>However, it failed to connect. After investigating I found that the ProtonMail Bridge only listens for requests from <code>127.0.0.1</code> i.e. the same computer it&rsquo;s running on. Alright, I know how to get arround that</p>
</section>
<section>
<h2 id=attempt-2---proxy-to-official-protonmail-bridge-deb>
Attempt 2 - Proxy to Official ProtonMail Bridge (deb)
<a class=heading-link href=#attempt-2---proxy-to-official-protonmail-bridge-deb>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h2>
<h3 id=socat-proxy>
Socat Proxy
<a class=heading-link href=#socat-proxy>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h3>
<p>I can use <code>socat</code> to proxy a different port taht will accept connections from all IP addresses and send to the ProtonBridge.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>socat TCP-LISTEN:25,fork TCP:127.0.0.1:1025 <span class=p>&amp;</span>
socat TCP-LISTEN:143,fork TCP:127.0.0.1:1143 <span class=p>&amp;</span>
</code></pre></div><p>So now <code>SERVER_IP:25</code> -> <code>127.0.0.1:1025</code> and <code>SERVER_IP:143</code> -> <code>127.0.0.1:1143</code>.</p>
<p>I updated the ports in my K-9 settings and it connected to the server!</p>
<h3 id=issues-1>
Issues
<a class=heading-link href=#issues-1>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h3>
<p>It grabbed my folders/labels from ProntonMail correctly and I was able to send emails successfully, which was good. But there was no mail showing up in my inbox or any folder. I tried go through the K-9 settings to see if I was missing something but it all looked okay.</p>
<p>I started going throught the logcat to see if there was anything and noticed there was an error message that K-9 was handling, <code>unsupported search query</code>.</p>
<p>I wasn&rsquo;t sure if this was from K-9 or from ProtonMail. Luckily both are open source so I could search and I found that it was from ProntMail</p>
<p><a href=https://github.com/ProtonMail/proton-bridge/blob/6ff4c8a73853a3794656e530c6f073e02a22568f/internal/imap/mailbox_messages.go#L316>ProtonMail/proton-bridge/internal/imap/mailbox_messages.go#L316</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// SearchMessages searches messages. The returned list must contain UIDs if
</span><span class=c1>// uid is set to true, or sequence numbers otherwise.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>im</span> <span class=o>*</span><span class=nx>imapMailbox</span><span class=p>)</span> <span class=nf>SearchMessages</span><span class=p>(</span><span class=nx>isUID</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>criteria</span> <span class=o>*</span><span class=nx>imap</span><span class=p>.</span><span class=nx>SearchCriteria</span><span class=p>)</span> <span class=p>(</span><span class=nx>ids</span> <span class=p>[]</span><span class=kt>uint32</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span> <span class=c1>//nolint[gocyclo]
</span><span class=c1></span>	<span class=c1>// Called from go-imap in goroutines - we need to handle panics for each function.
</span><span class=c1></span>	<span class=k>defer</span> <span class=nx>im</span><span class=p>.</span><span class=nx>panicHandler</span><span class=p>.</span><span class=nf>HandlePanic</span><span class=p>()</span>

	<span class=k>if</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Not</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Or</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
<span class=hl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;unsupported search query&#34;</span><span class=p>)</span>
</span>	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Body</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Text</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;Body and Text criteria not applied&#34;</span><span class=p>)</span>
	<span class=p>}</span>
</code></pre></div><p>Either K-9 is passing <code>criteria.Not</code> or <code>criteria.Or</code>. It turns out it&rsquo;s <code>criteria.Not</code>.</p>
<p>Now I can either edit the K-9 source or ProtonMail Bridge source and try again. I decided to ProtonMail Bridge source route.</p>
</section>
<section>
<h2 id=attempt-3---compile-protonmail-bridge-myself>
Attempt 3 - Compile ProtonMail Bridge Myself
<a class=heading-link href=#attempt-3---compile-protonmail-bridge-myself>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h2>
<p>I was looking around and found this <a href=https://github.com/shenxn/protonmail-bridge-docker>great docker setup</a> by GitHub user <code>shenxn</code>. I wish I would have found this before trying the initial setup with a gui as this one uses the cli to login and has some good documentation of how to set it up. They also have an example of how to build the ProtonMail Bridge from source and deploy it as a docker and funny enough was doing the same proxying I was doing.</p>
<h3 id=my-repo>
My Repo
<a class=heading-link href=#my-repo>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h3>
<p>Using that repo as a source, I decided to make my own repo for a docker image that I can apply some patches to fix stuff as I see fit.</p>
<p><a href=https://github.com/TChilderhose/protonmail-bridge-docker>Here is my repo</a></p>
<p>The way that it works is</p>
<ol>
<li>I get the source code from <a href=https://github.com/ProtonMail/proton-bridge>https://github.com/ProtonMail/proton-bridge</a></li>
<li>I apply the patches from the <code>./patches</code> folder in my repo (currently just ignore <code>criteria.Not</code> for K-9)</li>
<li>Build the source</li>
<li>Build the docker image</li>
</ol>
<p>Then when the docker image is spun up, it creates some <code>socat</code> proxies and starts the protonmail-bridge.</p>
<h3 id=solution>
Solution
<a class=heading-link href=#solution>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h3>
<p>Firstly I tore down my previous attempts (uninstalled the bridge, took down the <code>socat</code> proxies) just to avoid conflicts.</p>
<p>Setting up the docker is a two step process, first you need to do initialize to get your credentials</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>docker run --rm -it -v /path/to/protonmail:/root ghcr.io/tchilderhose/protonmail-bridge-docker init
</code></pre></div><p>and follow the steps in the readme from the repo</p>
<blockquote>
<p>Wait for the bridge to startup, use <code>login</code> command and follow the instructions to add your account into the bridge. Then use <code>info</code> to see the configuration information (username and password). After that, use exit to <code>exit</code> the bridge. You may need <code>CTRL+C</code> to exit the docker entirely.</p>
</blockquote>
<p>This will place a bunch of files needed for the bridge in the <code>/path/to/protonmail</code> folder (feel free to change this beforehand).</p>
<p>Then you can spin up the actual bridge for use. I use <code>docker-compose</code> so I just added</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>  protonmail:
    image:  ghcr.io/tchilderhose/protonmail-bridge-docker
    container_name: protonmail
    restart: unless-stopped
    ports:
      - &#34;1025:25/tcp&#34;
      - &#34;1143:143/tcp&#34;
    volumes:
      - /path/to/protonmail:/root
</code></pre></div><p>With that running I updated my K-9 settings with those port numbers (1025, 1143) and it worked! All my emails started showing up</p>
</section>
<section>
<h2 id=summary>
Summary
<a class=heading-link href=#summary>
<i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></i>
</a>
</h2>
<p>Getting this working took a few attempts, but it wasn&rsquo;t overall too bad. While it&rsquo;s only been a few days that it&rsquo;s been setup, I&rsquo;ve had no issues and have been really happy with it. There is a lot of good settings to play around with in K-9 to get it setup just right. The one thing that is missing is sending via an alias, which is something I havn&rsquo;t needed to do yet, so I will cross that</p>
<p>ProtonMail keep saying a new mobile app will be rolling out by years end, so if/when that drops, I will need to reevaluate if I will switch to that or keep this setup. But currently I am really liking it so will probably be sticking with it for awhile.</p>
</section>
</div>
<footer>
<div id=utterance-container src=https://utteranc.es/client.js repo=TChilderhose/tchilderhose.github.io issue-term=pathname label=comment crossorigin=anonymous>
</div>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
©
2021
Tyler Childerhose
·
Powered by <a href=https://gohugo.io/>Hugo</a>.
</section>
</footer>
</main>
<script defer src=/js/site.min.abadf6950b7dff946d074965e3f503e6af98c664f13fb6b2ab43277b841c70e6.js integrity="sha256-q632lQt9/5RtB0ll4/UD5q+YxmTxP7ayq0Mne4QccOY=" crossorigin=anonymous></script>
</body>
</html>